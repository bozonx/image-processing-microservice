# Документ Требований к Продукту (PRD)
# Микросервис Обработки Изображений

**Версия:** 1.0  
**Дата:** 2026-01-17  
**Статус:** Черновик

---

## 1. Краткое Резюме

### 1.1 Назначение
Микросервис обработки изображений — это выделенный сервис для выполнения CPU-интенсивных операций с изображениями. Он разгружает основной микросервис Media Storage от тяжелых задач обработки изображений, обеспечивая масштабируемые и эффективные возможности манипуляции изображениями.

### 1.2 Бизнес-Цели
- **Производительность**: Изоляция CPU-интенсивных операций для предотвращения блокировки основных сервисов приложения
- **Масштабируемость**: Независимое горизонтальное масштабирование на основе нагрузки обработки изображений
- **Надежность**: Надежная обработка ошибок и graceful degradation для операций с изображениями
- **Эффективность**: Оптимизация использования ресурсов через очередь задач и контроль параллелизма

### 1.3 Целевые Пользователи
- **Основной**: Микросервис Media Storage (внутреннее взаимодействие между сервисами)
- **Вторичный**: Любые внутренние сервисы, требующие возможностей обработки изображений

---

## 2. Обзор Продукта

### 2.1 Основная Функциональность
Микросервис предоставляет следующие возможности обработки изображений:

1. **Обработка и Оптимизация Изображений**
   - Конвертация форматов (WebP, AVIF, JPEG, PNG, GIF, TIFF, bmp, jpeg xl)
   - Настройка качества
   - Оптимизация размера
   - Удаление метаданных
   - Автоповорот на основе EXIF

2. **Извлечение EXIF Метаданных**
   - Извлечение полных EXIF данных
   - Санитизация и перевод ключей метаданных
   - Поддержка различных форматов изображений

3. **Трансформации Изображений**
   - Изменение размера (resize) с различными режимами fit
   - Обрезка (crop) - ручная и умная
   - Поворот (rotate) - 90°, 180°, 270°, произвольный угол
   - Отзеркаливание (flip) - горизонтальное, вертикальное
   - Автоповорот и отзеркаливание на основе EXIF ориентации

4. **Управление Метаданными**
   - Удаление всех метаданных

### 2.2 Технологический Стек
- **Runtime**: Node.js 22+
- **Framework**: NestJS 11+
- **HTTP Server**: Fastify 5+
- **Package Manager**: pnpm 10+
- **Image Processing**: Sharp 0.34.5 (libvips)
- **EXIF Extraction**: exifr 7.1.3
- **Task Queue**: p-queue 9.1.0
- **Logging**: Pino + nestjs-pino
- **Validation**: class-validator, class-transformer
- **Container**: Docker

---

## 3. Функциональные Требования

### 3.1 API Endpoints

#### 3.1.1 POST /api/v1/process
Обработка изображения с применением трансформаций и конвертации.

**Request Body:**
```typescript
{
  image: Buffer | base64,
  mimeType: string,
  
  // Приоритет задачи (опционально)
  priority?: number,              // 0-2, default 2 (низкий)
  
  // Параметры трансформации (опционально)
  transform?: {
    // Изменение размера
    resize?: {
      // Вариант 1: Ограничение максимального размера
      maxDimension?: number,      // 1-8192, пропорциональное уменьшение
      
      // Вариант 2: Точные размеры
      width?: number,             // 1-8192
      height?: number,            // 1-8192
      fit?: 'cover' | 'contain' | 'fill' | 'inside' | 'outside',  // default 'inside'
      
      // Дополнительные опции
      withoutEnlargement?: boolean,  // Не увеличивать изображение, default true
      position?: 'center' | 'top' | 'right' | 'bottom' | 'left' | 
                 'right top' | 'right bottom' | 'left bottom' | 'left top'  // для fit: cover/contain
    },
    
    // Обрезка
    crop?: {
      left: number,               // Отступ слева в пикселях
      top: number,                // Отступ сверху в пикселях
      width: number,              // Ширина области обрезки
      height: number              // Высота области обрезки
    },
    
    // Поворот
    rotate?: number,              // Градусы: 0, 90, 180, 270 или произвольный угол
    
    // Отзеркаливание
    flip?: {
      horizontal?: boolean,       // Отзеркалить горизонтально
      vertical?: boolean          // Отзеркалить вертикально
    },
    
    // Автоповорот на основе EXIF
    autoOrient?: boolean          // default true
  },
  
  // Параметры выходного изображения
  output?: {
    format?: 'webp' | 'avif' | 'jpeg' | 'png' | 'gif' | 'tiff',  // default from config
    quality?: number,             // 1-100, default from config
    lossless?: boolean,           // default from config (для WebP/AVIF)
    stripMetadata?: boolean,      // default from config
    effort?: number,              // 0-9, default from config (для WebP/AVIF)
    
    // Специфичные для AVIF
    avifChromaSubsampling?: '4:2:0' | '4:4:4',  // default from config
    
    // Специфичные для JPEG
    progressive?: boolean,        // Progressive JPEG, default false
    mozjpeg?: boolean,            // Использовать mozjpeg, default false
    
    // Специфичные для PNG
    compressionLevel?: number,    // 0-9, default 6
    palette?: boolean             // Использовать палитру, default false
  }
}
```

**Response:**
```typescript
{
  buffer: Buffer | base64,
  size: number,
  mimeType: string,
  dimensions: {
    width: number,
    height: number
  },
  stats?: {
    beforeBytes: number,
    afterBytes: number,
    reductionPercent: number
  }
}
```

**Status Codes:**
- `200 OK`: Успешная обработка
- `400 Bad Request`: Некорректный ввод (формат, размер, параметры)
- `408 Request Timeout`: Превышен таймаут обработки
- `413 Payload Too Large`: Изображение превышает лимит размера
- `500 Internal Server Error`: Ошибка обработки

**Примеры использования:**

1. Простое изменение размера с ограничением максимального размера:
```json
{
  "image": "...",
  "mimeType": "image/jpeg",
  "priority": 1,
  "transform": {
    "resize": {
      "maxDimension": 1920
    }
  },
  "output": {
    "format": "webp",
    "quality": 85
  }
}
```

2. Создание миниатюры с точными размерами:
```json
{
  "image": "...",
  "mimeType": "image/jpeg",
  "transform": {
    "resize": {
      "width": 300,
      "height": 300,
      "fit": "cover",
      "position": "center"
    }
  },
  "output": {
    "format": "webp",
    "quality": 80
  }
}
```

3. Обрезка и поворот:
```json
{
  "image": "...",
  "mimeType": "image/jpeg",
  "transform": {
    "crop": {
      "left": 100,
      "top": 100,
      "width": 800,
      "height": 600
    },
    "rotate": 90
  },
  "output": {
    "format": "jpeg",
    "quality": 90
  }
}
```

4. Только конвертация формата:
```json
{
  "image": "...",
  "mimeType": "image/png",
  "output": {
    "format": "webp",
    "quality": 85,
    "stripMetadata": true
  }
}
```

---

#### 3.1.2 POST /api/v1/exif
Извлечение EXIF метаданных из изображения.

**Request Body:**
```typescript
{
  image: Buffer | base64,
  mimeType: string,
  priority?: number               // 0-2, default 2 (низкий)
}
```

**Response:**
```typescript
{
  exif: Record<string, any> | null
}
```

**Status Codes:**
- `200 OK`: Успех (null если нет EXIF данных)
- `400 Bad Request`: Некорректный ввод
- `413 Payload Too Large`: Изображение превышает лимит размера
- `500 Internal Server Error`: Ошибка обработки

---

#### 3.1.3 GET /api/v1/health
Health check endpoint.

**Response:**
```typescript
{
  status: 'ok',
  timestamp: string,
  queue: {
    size: number,
    pending: number
  }
}
```

---

### 3.2 Управление Очередью Задач

#### 3.2.1 Конфигурация Очереди
- **Параллелизм**: Настраивается через `HEAVY_TASKS_MAX_CONCURRENCY` (по умолчанию: 4)
- **Таймаут**: Настраивается через `HEAVY_TASKS_QUEUE_TIMEOUT_MS` (по умолчанию: 30000ms)
- **Уровни Приоритета**:
  - `0` (Наивысший): Критические задачи
  - `1-9` (Средний): Обычные задачи
  - `10` (Низкий): Фоновые задачи (по умолчанию)
- **Установка Приоритета**: Клиент может указать приоритет в запросе через поле `priority` (опционально)
- **Приоритет по Умолчанию**: Если приоритет не указан, используется низкий приоритет (10)

#### 3.2.2 Поведение Очереди
- FIFO в пределах одного уровня приоритета
- Автоматическая обработка таймаутов
- Graceful shutdown с завершением задач
- Отклонение новых задач во время shutdown

---

### 3.3 Обработка Ошибок

#### 3.3.1 Ошибки Валидации Ввода (400)
- Некорректный формат изображения
- Некорректные параметры (вне диапазона)
- Поврежденные данные изображения
- Отсутствующие обязательные поля
- Конфликтующие параметры (например, maxDimension и width/height одновременно)

#### 3.3.2 Ошибки Лимита Размера (413)
- Изображение превышает `IMAGE_MAX_BYTES_MB`
- Размеры превышают максимально допустимые

#### 3.3.3 Ошибки Таймаута (408)
- Обработка превышает `HEAVY_TASKS_QUEUE_TIMEOUT_MS`

#### 3.3.4 Ошибки Обработки (500)
- Сбои обработки Sharp
- Исчерпание памяти
- Неожиданные ошибки

#### 3.3.5 Формат Ответа с Ошибкой
```typescript
{
  statusCode: number,
  message: string,
  error: string,
  timestamp: string,
  path: string
}
```

---

## 4. Нефункциональные Требования

### 4.1 Производительность

#### 4.1.1 Время Отклика
- **Извлечение EXIF**: < 500ms (p95)
- **Обработка без трансформаций**: < 1s (p95)
- **Обработка с трансформациями**: < 2s (p95)
- **Сложные трансформации**: < 3s (p95)

#### 4.1.2 Пропускная Способность
- Поддержка минимум 10 параллельных задач обработки изображений
- Емкость очереди: неограниченная (в пределах памяти)

#### 4.1.3 Использование Ресурсов
- **CPU**: Эффективное использование доступных ядер
- **Memory**: Пиковая память ~2GB при настройках по умолчанию
- **Disk**: Постоянное хранилище не требуется (stateless)

---

### 4.2 Масштабируемость

#### 4.2.1 Горизонтальное Масштабирование
- Stateless дизайн позволяет запускать несколько инстансов
- Распределение через load balancer
- Нет общего состояния между инстансами

#### 4.2.2 Вертикальное Масштабирование
- `HEAVY_TASKS_MAX_CONCURRENCY` должен соответствовать количеству CPU ядер
- Память масштабируется как `IMAGE_MAX_BYTES_MB` × `CONCURRENCY`

---

### 4.3 Надежность

#### 4.3.1 Доступность
- Цель: 99.9% uptime
- Graceful degradation при ошибках
- Health check для мониторинга

#### 4.3.2 Отказоустойчивость
- Автоматический retry не реализован (ответственность клиента)
- Защита от зависших задач через timeout
- Предотвращение утечек памяти

---

### 4.4 Безопасность

#### 4.4.1 Валидация Ввода
- Строгая валидация MIME типов
- Лимиты размера файлов
- Валидация диапазонов параметров
- Санитизация буферов

#### 4.4.2 Защита Ресурсов
- Лимиты памяти через конфигурацию
- Лимиты CPU времени через таймауты
- Отсутствие выполнения произвольного кода

#### 4.4.3 Конфиденциальность Данных
- Отсутствие постоянного хранения изображений
- Опциональное удаление метаданных
- Отсутствие логирования содержимого изображений

---

### 4.5 Наблюдаемость

#### 4.5.1 Логирование
- Структурированное JSON логирование (Pino)
- Уровни логов: trace, debug, info, warn, error, fatal
- Ключевые метрики в логах:
  - Время обработки
  - Размеры входа/выхода
  - Коэффициенты сжатия
  - Размер очереди
  - Детали ошибок

#### 4.5.2 Метрики (Будущее Улучшение)
- Количество запросов по endpoint
- Гистограммы длительности обработки
- Глубина очереди во времени
- Частота ошибок по типам
- Использование ресурсов

#### 4.5.3 Мониторинг Здоровья
- Endpoint `/api/v1/health`
- Отчет о статусе очереди
- Готовность к интеграции с системами мониторинга

---

## 5. Конфигурация

### 5.1 Переменные Окружения

```bash
# Конфигурация Сервера
NODE_ENV=production                    # production | development | test
LISTEN_HOST=0.0.0.0                   # Адрес прослушивания
LISTEN_PORT=3000                      # Порт прослушивания
BASE_PATH=                            # Префикс базового пути (опционально)
LOG_LEVEL=info                        # trace|debug|info|warn|error|fatal|silent
TZ=UTC                                # Часовой пояс

# Лимиты Обработки
IMAGE_MAX_BYTES_MB=25                 # Максимальный размер изображения в MB
HEAVY_TASKS_MAX_CONCURRENCY=4         # Параллельные задачи обработки
HEAVY_TASKS_QUEUE_TIMEOUT_MS=30000    # Таймаут задачи в миллисекундах

# Настройки по Умолчанию для Обработки
IMAGE_DEFAULT_FORMAT=webp             # webp | avif | jpeg | png | gif | tiff
IMAGE_DEFAULT_MAX_DIMENSION=3840      # Максимальный размер (пиксели)
IMAGE_DEFAULT_QUALITY=80              # Качество 1-100
IMAGE_DEFAULT_EFFORT=6                # Усилие 0-9 (скорость vs качество)
IMAGE_DEFAULT_LOSSLESS=false          # Сжатие без потерь
IMAGE_DEFAULT_STRIP_METADATA=false    # Удалять метаданные по умолчанию
IMAGE_DEFAULT_AUTO_ORIENT=true        # Автоповорот по умолчанию

# Специфичные для AVIF
IMAGE_AVIF_CHROMA_SUBSAMPLING=4:2:0   # 4:2:0 | 4:4:4

# Специфичные для JPEG
IMAGE_JPEG_PROGRESSIVE=false          # Progressive JPEG
IMAGE_JPEG_MOZJPEG=false              # Использовать mozjpeg

# Специфичные для PNG
IMAGE_PNG_COMPRESSION_LEVEL=6         # 0-9

# Shutdown
SHUTDOWN_TIMEOUT_MS=30000             # Таймаут graceful shutdown
```

---

## 6. Требования к Интеграции

### 6.1 Интеграция с Микросервисом Media Storage

#### 6.1.1 Необходимые Изменения в Media Storage
1. **Настройка HTTP Клиента**
   - Добавить HTTP клиент (fetch или @nestjs/axios)
   - Настроить базовый URL: `IMAGE_PROCESSING_SERVICE_URL`
   - Установить таймаут: `IMAGE_PROCESSING_TIMEOUT_MS` (> 30s)
   - Реализовать логику retry (2-3 попытки)

2. **Рефакторинг Сервисов**
   - Заменить локальные вызовы Sharp на HTTP запросы
   - Заменить локальные вызовы exifr на HTTP запросы
   - Graceful обработка HTTP ошибок
   - Поддержка обратной совместимости

3. **Конфигурация**
   ```bash
   IMAGE_PROCESSING_SERVICE_URL=http://image-processing:3000
   IMAGE_PROCESSING_TIMEOUT_MS=35000
   IMAGE_PROCESSING_RETRY_ATTEMPTS=2
   ```

4. **Зависимости для Удаления**
   - `sharp` (самая тяжелая зависимость)
   - `exifr`
   - `p-queue` (если используется только для обработки изображений)

#### 6.1.2 Стратегия Миграции
1. Развернуть Image Processing Microservice
2. Обновить конфигурацию Media Storage
3. Развернуть обновленный Media Storage
4. Мониторить частоту ошибок и производительность
5. Удалить старые зависимости после валидации

---

### 6.2 API Контракт

#### 6.2.1 Формат Запроса
- **Content-Type**: `application/json`
- **Body**: JSON с base64-кодированным изображением или Buffer
- **Timeout**: Клиент должен установить > 30s

#### 6.2.2 Формат Ответа
- **Content-Type**: `application/json`
- **Body**: JSON с base64-кодированным результатом или Buffer

#### 6.2.3 Обработка Ошибок
- Клиент должен обрабатывать все HTTP коды ошибок
- Реализовать exponential backoff для retry
- Логировать сбои для отладки

---

## 7. Требования к Тестированию

### 7.1 Unit Тесты

#### 7.1.1 Требования к Покрытию
- Минимум 80% покрытия кода
- Все сервисы должны иметь unit тесты
- Все DTO должны иметь тесты валидации

#### 7.1.2 Тестовые Случаи
- **Сервис Обработки**
  - Различные уровни качества
  - Разные форматы (WebP, AVIF, JPEG, PNG, GIF, TIFF)
  - Lossless vs lossy
  - Удаление метаданных
  - Автоориентация
  - Граничные случаи (очень маленькие, очень большие изображения)
  - Все режимы fit
  - Комбинации трансформаций

- **Сервис EXIF**
  - Изображения с EXIF
  - Изображения без EXIF
  - Поврежденные EXIF данные
  - Применение лимита размера

- **Сервис Очереди**
  - Приоритизация задач
  - Обработка таймаутов
  - Graceful shutdown
  - Параллельное выполнение

---

### 7.2 E2E Тесты

#### 7.2.1 Тестовые Сценарии
- Полный цикл запрос/ответ для каждого endpoint
- Обработка больших файлов
- Обработка некорректного ввода
- Параллельные запросы
- Сценарии таймаута
- Ответы с ошибками

#### 7.2.2 Тесты Производительности
- Нагрузочное тестирование с множественными параллельными запросами
- Обнаружение утечек памяти
- Поведение очереди под нагрузкой
- Graceful shutdown с ожидающими задачами

---

### 7.3 Интеграционные Тесты

#### 7.3.1 Интеграция с Media Storage
- Mock запросов Media Storage
- Проверка совместимости формата запрос/ответ
- Тестирование распространения ошибок
- Валидация логики retry

---

## 8. Требования к Развертыванию

### 8.1 Docker

#### 8.1.1 Требования к Dockerfile
- Базовый образ: `node:22-alpine`
- Системные зависимости: `vips-dev`, `build-base`, `python3`
- Multi-stage build для оптимизации
- Выполнение от non-root пользователя
- Включен health check

#### 8.1.2 Оптимизация Размера Образа
- Использовать Alpine Linux
- Удалять build зависимости после установки
- Минимизировать слои

---

### 8.2 Требования к Ресурсам

#### 8.2.1 Минимальные Ресурсы
- **CPU**: 2 ядра
- **Memory**: 2GB RAM
- **Disk**: 500MB (для образа и зависимостей)

#### 8.2.2 Рекомендуемые Ресурсы (Production)
- **CPU**: 4 ядра
- **Memory**: 4GB RAM
- **Disk**: 1GB

#### 8.2.3 Рекомендации по Масштабированию
- 1 инстанс на 4 CPU ядра
- `HEAVY_TASKS_MAX_CONCURRENCY` = количество CPU ядер
- Memory = 1GB + (IMAGE_MAX_BYTES_MB × CONCURRENCY × 2)

---

### 8.3 Мониторинг и Алертинг

#### 8.3.1 Health Checks
- Endpoint: `GET /api/v1/health`
- Частота: Каждые 30s
- Таймаут: 5s
- Порог сбоев: 3 последовательных сбоя

#### 8.3.2 Алерты
- Высокая частота ошибок (> 5%)
- Большая глубина очереди (> 50 задач)
- Высокое использование памяти (> 90%)
- Высокое использование CPU (> 90%)
- Медленное время отклика (p95 > пороговых значений)

---

## 9. Требования к Документации

### 9.1 API Документация
- OpenAPI/Swagger спецификация
- Примеры запросов/ответов
- Документация кодов ошибок
- Требования к аутентификации (если есть)

### 9.2 Документация Развертывания
- Инструкции по настройке Docker
- Справочник переменных окружения
- Требования к ресурсам
- Рекомендации по масштабированию

### 9.3 Документация Интеграции
- Руководство по интеграции клиента
- Лучшие практики обработки ошибок
- Стратегии retry
- Советы по оптимизации производительности

---

## 10. Метрики Успеха

### 10.1 Метрики Производительности
- **Время Отклика**: p95 в пределах определенных SLA
- **Пропускная Способность**: Обработка 100+ запросов/минуту на инстанс
- **Частота Ошибок**: < 1% при нормальной нагрузке

### 10.2 Метрики Надежности
- **Uptime**: 99.9%
- **Успешные Graceful Shutdowns**: 100%
- **Утечки Памяти**: 0

### 10.3 Бизнес Метрики
- **Снижение Стоимости Ресурсов**: Оптимизация использования CPU/памяти
- **Масштабируемость**: Поддержка 10x увеличения трафика с горизонтальным масштабированием
- **Продуктивность Разработчиков**: Снижение сложности сервиса Media Storage

---

## 11. Будущие Улучшения

### 11.1 Фаза 2 Функции
- Endpoint пакетной обработки
- Асинхронная обработка с webhooks
- Автоопределение формата изображения
- Умная обрезка (определение лиц)
- Продвинутые фильтры (размытие, резкость и т.д.)
- **Водяные знаки** (изображения и текст)

### 11.2 Фаза 3 Функции
- Генерация миниатюр видео
- Оптимизация GIF
- Конвертация PDF в изображение
- OCR возможности
- AI-улучшение изображений

### 11.3 Улучшения Инфраструктуры
- Экспорт метрик Prometheus
- Распределенная трассировка (OpenTelemetry)
- Rate limiting
- Аутентификация/авторизация
- Слой кэширования для повторяющихся операций

---

## 12. Риски и Меры Снижения

### 12.1 Технические Риски

| Риск | Влияние | Вероятность | Снижение |
|------|---------|-------------|----------|
| Исчерпание памяти с большими изображениями | Высокое | Среднее | Строгие лимиты размера, применение таймаутов |
| Уязвимости библиотеки Sharp | Высокое | Низкое | Регулярные обновления зависимостей, сканирование безопасности |
| Переполнение очереди при высокой нагрузке | Среднее | Среднее | Мониторинг размера очереди, обработка backpressure |
| Проблемы с таймаутом при сложных операциях | Среднее | Среднее | Настраиваемые таймауты, оптимизация операций |

### 12.2 Операционные Риски

| Риск | Влияние | Вероятность | Снижение |
|------|---------|-------------|----------|
| Недоступность сервиса | Высокое | Низкое | Health checks, auto-restart, множественные инстансы |
| Breaking changes в интеграции | Среднее | Низкое | Версионирование API, комплексные тесты |
| Избыточное выделение ресурсов | Низкое | Среднее | Мониторинг, right-sizing на основе метрик |

---

## 13. Критерии Приемки

### 13.1 Функциональная Приемка
- [ ] Все API endpoints реализованы и протестированы
- [ ] Все операции с изображениями дают корректные результаты
- [ ] Обработка ошибок покрывает все граничные случаи
- [ ] Управление очередью работает согласно спецификации

### 13.2 Нефункциональная Приемка
- [ ] Performance SLA достигнуты при нагрузочном тестировании
- [ ] Достигнуто 80%+ покрытие кода
- [ ] Все E2E тесты проходят
- [ ] Документация полная и точная

### 13.3 Интеграционная Приемка
- [ ] Интеграция с Media Storage успешна
- [ ] Нет регрессий в функциональности Media Storage
- [ ] Старые зависимости удалены из Media Storage
- [ ] Production развертывание успешно

---

## 14. План Реализации

> **Детальный план реализации доступен в файле `dev_docs/implementation-plan.md`**

### Краткий Обзор

Реализация разбита на 3 основных этапа для достижения MVP:

### Этап 1: Подготовка Инфраструктуры
**Цель**: Подготовить полную инфраструктуру проекта

- [ ] Создать файловую структуру проекта
- [ ] Настроить зависимости (package.json)
- [ ] Подготовить переменные окружения (.env.*.example)
- [ ] Настроить Docker (Dockerfile, docker-compose.yml)
- [ ] Написать README.md на русском языке
- [ ] Создать базовые тесты для проверки запуска
- [ ] Убедиться что сервис запускается без ошибок

**Результат**: Проект готов к разработке, сервис запускается

---

### Этап 2: Реализация MVP (Конвертация и EXIF)
**Цель**: Реализовать основную функциональность

- [ ] Создать конфигурацию (config/image.config.ts)
- [ ] Реализовать DTO для валидации (process-image.dto.ts, exif.dto.ts)
- [ ] Реализовать QueueService с поддержкой приоритетов
- [ ] Реализовать ExifService для извлечения метаданных
- [ ] Реализовать ImageProcessorService для обработки изображений
- [ ] Создать ImageProcessingController
- [ ] Интегрировать все в ImageProcessingModule
- [ ] Провести ручное тестирование через curl/Postman

**Результат**: MVP работает, можно обрабатывать изображения и извлекать EXIF

---

### Этап 3: Unit Тесты и Финализация MVP
**Цель**: Покрыть код тестами и завершить MVP

- [ ] Написать unit тесты для QueueService
- [ ] Написать unit тесты для ExifService
- [ ] Написать unit тесты для ImageProcessorService
- [ ] Достичь покрытия кода >= 80%
- [ ] Убедиться что все тесты проходят
- [ ] Обновить документацию
- [ ] Подготовить к production развертыванию

**Результат**: MVP полностью готов к использованию

---

### Roadmap: Дальнейшее Развитие

После завершения MVP планируется реализация следующих функций:

#### v1.1 - Продвинутые Трансформации
- Crop (обрезка)
- Rotate (поворот на произвольный угол)
- Flip (отзеркаливание)

#### v1.2 - Расширенная Поддержка Форматов
- BMP
- JPEG XL
- Оптимизация GIF

#### v1.3 - Водяные Знаки
- Изображения-водяные знаки
- Текстовые водяные знаки

#### v1.4 - Пакетная Обработка
- Endpoint для обработки нескольких изображений
- Оптимизация производительности

#### v1.5 - Асинхронная Обработка
- Webhook поддержка
- Хранилище задач (Redis)

#### v1.6 - Мониторинг и Метрики
- Prometheus метрики
- OpenTelemetry трассировка

#### v2.0 - Продвинутые Функции
- OCR
- AI улучшение изображений

**Подробности в файле `dev_docs/implementation-plan.md`**

---

## 15. Приложения

### 15.1 Глоссарий
- **Sharp**: Высокопроизводительная библиотека обработки изображений для Node.js на основе libvips
- **EXIF**: Exchangeable Image File Format - стандарт метаданных для изображений
- **WebP**: Современный формат изображений с превосходным сжатием
- **AVIF**: AV1 Image File Format - формат изображений следующего поколения
- **libvips**: Быстрая библиотека обработки изображений на C
- **p-queue**: Очередь с приоритетами на основе Promise для Node.js
- **fit**: Режим подгонки изображения при изменении размера
  - **cover**: Обрезать по центру для заполнения размеров
  - **contain**: Вписать полностью, сохраняя пропорции
  - **fill**: Растянуть для заполнения размеров
  - **inside**: Уменьшить для вписывания в размеры
  - **outside**: Увеличить для покрытия размеров

### 15.2 Поддерживаемые Форматы

| Формат | Чтение | Запись | Особенности |
|--------|--------|--------|-------------|
| JPEG | ✓ | ✓ | Progressive, mozjpeg support |
| PNG | ✓ | ✓ | Compression levels, palette |
| WebP | ✓ | ✓ | Lossless/lossy, effort levels |
| AVIF | ✓ | ✓ | Chroma subsampling, effort levels |
| GIF | ✓ | ✓ | Animation support (first frame) |
| TIFF | ✓ | ✓ | Multi-page support (first page) |

### 15.3 Ссылки
- [Sharp Documentation](https://sharp.pixelplumbing.com/)
- [exifr Documentation](https://github.com/MikeKovarik/exifr)
- [p-queue Documentation](https://github.com/sindresorhus/p-queue)
- [NestJS Documentation](https://docs.nestjs.com/)
- [Fastify Documentation](https://www.fastify.io/)

---

**Контроль Документа**

| Версия | Дата | Автор | Изменения |
|--------|------|-------|-----------|
| 1.0 | 2026-01-17 | AI Assistant | Создание PRD |

