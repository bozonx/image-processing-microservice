# –ú–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –û–±—Ä–∞–±–æ—Ç–∫–∏ –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π

–í—ã—Å–æ–∫–æ–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω—ã–π –º–∏–∫—Ä–æ—Å–µ—Ä–≤–∏—Å –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –Ω–∞ –±–∞–∑–µ NestJS –∏ Sharp.

## –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏

- ‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤ (WebP, AVIF, JPEG, PNG, GIF, TIFF)
- ‚úÖ –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ EXIF –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö
- ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—Ä–∞ —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ —Ä–µ–∂–∏–º–∞–º–∏ fit
- ‚úÖ –û–±—Ä–µ–∑–∫–∞, –ø–æ–≤–æ—Ä–æ—Ç, –æ—Ç–∑–µ—Ä–∫–∞–ª–∏–≤–∞–Ω–∏–µ
- ‚úÖ –ê–≤—Ç–æ–ø–æ–≤–æ—Ä–æ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ EXIF
- ‚úÖ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥—å—é –∑–∞–¥–∞—á —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
- ‚úÖ Graceful shutdown

## –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è

- Node.js 22+
- pnpm 10+
- Docker (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

## –ë—ã—Å—Ç—Ä—ã–π –°—Ç–∞—Ä—Ç

### –õ–æ–∫–∞–ª—å–Ω–∞—è –†–∞–∑—Ä–∞–±–æ—Ç–∫–∞

1. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π:
```bash
pnpm install
```

2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
```bash
cp .env.development.example .env.development
```

3. –ó–∞–ø—É—Å–∫ –≤ —Ä–µ–∂–∏–º–µ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏:
```bash
pnpm start:dev
```

–°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: `http://localhost:3000/api/v1`

### Production –°–±–æ—Ä–∫–∞

1. –°–±–æ—Ä–∫–∞:
```bash
pnpm build
```

2. –ó–∞–ø—É—Å–∫:
```bash
pnpm start:prod
```

### Docker

1. –°–±–æ—Ä–∫–∞ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:
```bash
pnpm build
```

2. –ó–∞–ø—É—Å–∫ —á–µ—Ä–µ–∑ Docker Compose:
```bash
docker compose -f docker/docker-compose.yml up -d --build
```

–°–µ—Ä–≤–∏—Å –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø–æ –∞–¥—Ä–µ—Å—É: `http://localhost:3000/api/v1`

## API Endpoints

### POST /api/v1/process

–û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ–º —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏–∏.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**
- `image` (Buffer | base64) - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
- `mimeType` (string) - MIME —Ç–∏–ø –≤—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- `priority` (number, optional) - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∑–∞–¥–∞—á–∏ (0-2, default: 2)
- `transform` (object, optional) - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏
- `output` (object, optional) - –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "image": "base64_encoded_image",
  "mimeType": "image/jpeg",
  "priority": 1,
  "transform": {
    "resize": {
      "maxDimension": 1920
    }
  },
  "output": {
    "format": "webp",
    "quality": 85
  }
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "buffer": "base64_encoded_result",
  "size": 123456,
  "mimeType": "image/webp",
  "dimensions": {
    "width": 1920,
    "height": 1080
  },
  "stats": {
    "beforeBytes": 500000,
    "afterBytes": 123456,
    "reductionPercent": 75.3
  }
}
```

### POST /api/v1/exif

–ò–∑–≤–ª–µ—á–µ–Ω–∏–µ EXIF –º–µ—Ç–∞–¥–∞–Ω–Ω—ã—Ö –∏–∑ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è.

**–ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∑–∞–ø—Ä–æ—Å–∞:**
- `image` (Buffer | base64) - –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- `mimeType` (string) - MIME —Ç–∏–ø –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
- `priority` (number, optional) - –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –∑–∞–¥–∞—á–∏ (0-2, default: 2)

**–ü—Ä–∏–º–µ—Ä –∑–∞–ø—Ä–æ—Å–∞:**
```json
{
  "image": "base64_encoded_image",
  "mimeType": "image/jpeg",
  "priority": 0
}
```

**–û—Ç–≤–µ—Ç:**
```json
{
  "exif": {
    "Make": "Canon",
    "Model": "EOS 5D Mark IV",
    "DateTimeOriginal": "2024:01:15 14:30:00",
    "ExposureTime": 0.004,
    "FNumber": 2.8,
    "ISO": 400
  }
}
```

### GET /api/v1/health

–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Ä–≤–∏—Å–∞.

**–û—Ç–≤–µ—Ç:**
```json
{
  "status": "ok",
  "timestamp": "2024-01-17T12:00:00.000Z",
  "queue": {
    "size": 5,
    "pending": 2
  }
}
```

## –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è

–í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∑–∞–¥–∞—é—Ç—Å—è —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è. –°–º. `.env.production.example` –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞.

### –û—Å–Ω–æ–≤–Ω—ã–µ –ü–∞—Ä–∞–º–µ—Ç—Ä—ã

- `LISTEN_PORT` - –ü–æ—Ä—Ç —Å–µ—Ä–≤–∏—Å–∞ (default: 3000)
- `LOG_LEVEL` - –£—Ä–æ–≤–µ–Ω—å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏—è (default: info)
- `IMAGE_MAX_BYTES_MB` - –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ MB (default: 25)
- `HEAVY_TASKS_MAX_CONCURRENCY` - –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á (default: 4)
- `IMAGE_DEFAULT_FORMAT` - –§–æ—Ä–º–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (default: webp)
- `IMAGE_DEFAULT_QUALITY` - –ö–∞—á–µ—Å—Ç–≤–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é (default: 80)

## –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### Unit –¢–µ—Å—Ç—ã
```bash
pnpm test:unit
```

### E2E –¢–µ—Å—Ç—ã
```bash
pnpm test:e2e
```

### –ü–æ–∫—Ä—ã—Ç–∏–µ –ö–æ–¥–∞
```bash
pnpm test:cov
```

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–∞

### –ú–æ–¥—É–ª–∏

- **HealthModule** - Health check endpoint
- **ImageProcessingModule** - –û—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
  - `ImageProcessorService` - –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è (–±—É–¥–µ—Ç –≤ –≠—Ç–∞–ø–µ 2)
  - `ExifService` - –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ EXIF (–±—É–¥–µ—Ç –≤ –≠—Ç–∞–ø–µ 2)
  - `QueueService` - –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—á–µ—Ä–µ–¥—å—é –∑–∞–¥–∞—á (–±—É–¥–µ—Ç –≤ –≠—Ç–∞–ø–µ 2)

### –û—á–µ—Ä–µ–¥—å –ó–∞–¥–∞—á

–°–µ—Ä–≤–∏—Å –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `p-queue` –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω—ã–º–∏ –∑–∞–¥–∞—á–∞–º–∏:
- –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç—ã: 0 (–≤—ã—Å–æ–∫–∏–π), 1 (—Å—Ä–µ–¥–Ω–∏–π), 2 (–Ω–∏–∑–∫–∏–π)
- –¢–∞–π–º–∞—É—Ç –Ω–∞ –∑–∞–¥–∞—á—É: 30 —Å–µ–∫—É–Ω–¥
- Graceful shutdown —Å –æ–∂–∏–¥–∞–Ω–∏–µ–º –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–¥–∞—á

## –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å

### SLA

- EXIF extraction: < 500ms (p95)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–µ–∑ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–π: < 1s (p95)
- –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏—è–º–∏: < 2s (p95)

### –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏

- CPU: 4 —è–¥—Ä–∞
- Memory: 4GB RAM
- `HEAVY_TASKS_MAX_CONCURRENCY` = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ CPU —è–¥–µ—Ä

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Health Check

```bash
curl http://localhost:3000/api/v1/health
```

### –õ–æ–≥–∏

–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ JSON –ª–æ–≥–∏ —á–µ—Ä–µ–∑ Pino:
```json
{
  "level": "info",
  "time": 1705497600000,
  "msg": "Image processed",
  "beforeBytes": 500000,
  "afterBytes": 123456,
  "reductionPercent": 75.3,
  "format": "webp",
  "duration": 850
}
```

## –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è

### –ü—Ä–∏–º–µ—Ä —Å fetch (Node.js)

```typescript
const response = await fetch('http://localhost:3000/api/v1/process', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
  },
  body: JSON.stringify({
    image: imageBuffer.toString('base64'),
    mimeType: 'image/jpeg',
    priority: 1,
    output: {
      format: 'webp',
      quality: 85,
    },
  }),
});

const result = await response.json();
const processedImage = Buffer.from(result.buffer, 'base64');
```

## –°—Ç–∞—Ç—É—Å –†–∞–∑—Ä–∞–±–æ—Ç–∫–∏

### ‚úÖ –≠—Ç–∞–ø 1: –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –ò–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã (–ó–∞–≤–µ—Ä—à–µ–Ω)
- [x] –§–∞–π–ª–æ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ –ø—Ä–æ–µ–∫—Ç–∞
- [x] –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
- [x] –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è
- [x] Docker –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è
- [x] README.md –Ω–∞ —Ä—É—Å—Å–∫–æ–º
- [x] –ë–∞–∑–æ–≤—ã–µ —Ç–µ—Å—Ç—ã
- [x] –°–µ—Ä–≤–∏—Å –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è

### üöß –≠—Ç–∞–ø 2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è MVP (–í —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ)
- [ ] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
- [ ] DTO –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
- [ ] QueueService —Å –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞–º–∏
- [ ] ExifService
- [ ] ImageProcessorService
- [ ] ImageProcessingController
- [ ] –†—É—á–Ω–æ–µ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ

### üìã –≠—Ç–∞–ø 3: Unit –¢–µ—Å—Ç—ã
- [ ] –¢–µ—Å—Ç—ã ImageProcessorService
- [ ] –¢–µ—Å—Ç—ã ExifService
- [ ] –¢–µ—Å—Ç—ã QueueService
- [ ] –ü–æ–∫—Ä—ã—Ç–∏–µ –∫–æ–¥–∞ 80%+

## Roadmap

### v1.1 (–§–∞–∑–∞ 2)
- [ ] –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –≤—Å–µ—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ (BMP, JPEG XL)
- [ ] –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ (crop, rotate, flip)
- [ ] –£–º–Ω–∞—è –æ–±—Ä–µ–∑–∫–∞
- [ ] –í–æ–¥—è–Ω—ã–µ –∑–Ω–∞–∫–∏

### v1.2 (–§–∞–∑–∞ 3)
- [ ] –ü–∞–∫–µ—Ç–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞
- [ ] –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ —Å webhooks
- [ ] Prometheus –º–µ—Ç—Ä–∏–∫–∏
- [ ] Rate limiting

## –õ–∏—Ü–µ–Ω–∑–∏—è

MIT

## –ü–æ–¥–¥–µ—Ä–∂–∫–∞

–î–ª—è –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π —Å–æ–∑–¥–∞–≤–∞–π—Ç–µ issue –≤ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏.
